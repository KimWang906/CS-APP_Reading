# CS:APP

## 컴파일

### 컴파일 하려는 코드

```c
    #include<stdio.h>

    int main() 
    {
        printf("hello, world\n");
        return 0;
    }
```

컴파일은 4단계를 거쳐서 실행된다. 이 네 단계를 실행하는 **프로그램들(전처리기, 컴파일러, 어셈블러, 링커)**을 합쳐서 **컴파일 시스템**이라고 부릅니다.

* **전처리 단계:** **전처리기(C Pre-Processer)** 는 본래의 C 프로그램을 # 문자로 시작하는 [디렉티브(directive)](https://docs.microsoft.com/ko-kr/cpp/preprocessor/hash-line-directive-c-cpp?view=msvc-170)에 따라 수정합니다. 예를 들어 C 프로그램 파일 코드 첫 줄의 `#include<stdio.h>`는 전처리기에게 시스템 헤더파일인 `stdio.h`를 프로그램 문장에 직접 삽입하라고 지시를 하게 됩니다. 그에 대한 결과로 `.i`로 끝나는 새로운 C 코드가 생성됩니다.
* **컴파일 단계:** **컴파일러(cc1)** 는 전처리 단계에서 만들어진 `.i`를 텍스트파일인 `.s`로 번역하며, 이 파일에는 어셈블리어 프로그램이 저장됩니다. 이 프로그램은 다음과 같은 `main()` 함수의 정의를 포함합니다.

```asm
    main:
        subq    $8, %rsp
        movl    $.LC0, %edi
        call    puts
        movl    $0, %eax
        addq    $8, %rsp
        ret
```

* **어셈블리 단계:** 다음에는 **어셈블러(as)**가 `.s` 파일을 기계어 명령으로 번역하고, 이들을 재배치가능 목적프로그램의 형태로 묶어서 `.o`라는 확장자로 목적파일에 그 결과를 저장합니다. 이 파일은 main 함수의 인스트럭션들을 인코등하기 위한 17byte를 포함하는 바이너리 파일입니다. `.o` 파일을 텍스트 편집기로 열어볼 경우 쓰레기 같은 데이터로 보일 것입니다.
* **링크 단계:** 해당 프로그램이 C 컴파일러에서 제공하는 표준 C 라이브러리에 들어있는 `printf` 함수를 호출하는 것에 주목할 필요가 있습니다. `printf` 함수는 이미 컴파일된 별도의 목적파일인 `printf.o`에 들어있으며, 이 파일은 합치려고 하는 목적파일과 어떤 형태로든 결합되어야 합니다. `링커 프로그램(ld)`이 이 통합작업을 수행하게 됩니다. 그 결과가 되는 실행이 가능한 목적파일(즉, 실행파일)로 메모리에 적재되어 시스템에 의해 실행됩니다.

### 우리가 컴파일 시스템이 어떻게 동작하는지 이해하는 것이 중요한 이유

간단하게 [출력만 하는 프로그램](#컴파일-하려는-코드)의 경우 컴파일 시스템이 정확하고 효율적인 기계어 코드를 만들어 줄 것이라고 기대할 수 있지만 프로그래머들이 어떻게 컴파일 시스템이 동작하는지 이해해야 하는 중요한 이유가 있습니다.

* **프로그램 성능 최적화하기:**
최신 컴파일러들은 복잡한 도구로 대체적으로 우수한 코드를 생성합니다.  
프로그래머로서 효율적인 코드를 작성하기 위해 컴파일러의 내부 동작을 알 필요는 없지만 C 프로그램 작성 시 올바른 판든을 하기 위해서는 기계어 수준 코드에 대한 기본적인 이해를 할 필요성이 있으며, 컴파일러가 어떻게 C 문장들을 기계어 코드로 번역하는지 알 필요가 있습니다.
* **링크 에러 이해하기:**
작성자의 경험에 의하면, 가장 당혹스러운 프로그래밍 에러는 링커의 동작과 관련되어 있으며, 큰 규모의 소프트웨어 시스템을 빌드하려는 경우 더욱 그렇습니다.
* **보안 약점(security hole) 피하기:**
[오랫동안 버퍼 오버플로우(buffer overflow)](https://en.wikipedia.org/wiki/Buffer_overflow) 취약성이 인터넷과 네트워크상의 보안 약점의 주요 원인으로 설명되었습니다.

### 용어 정리

**directive** : directive는 줄 번호 및 파일 이름에 대한 컴파일러의 보고된 값을 지정된 줄 번호와 파일 이름으로 설정하도록 전처리기에게 지시합니다.  
**cc1**: cc1은 GNU에서 만든 C언어 컴파일러입니다.  
